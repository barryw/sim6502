when:
  - event: push
    branch: main
    evaluate: 'CI_COMMIT_MESSAGE not contains "chore(version):"'

labels:
  platform: linux/amd64

steps:
  - name: build-and-test
    image: mcr.microsoft.com/dotnet/sdk:10.0
    commands:
      - dotnet restore
      - dotnet build -c Release
      - dotnet test -c Release

  - name: release
    image: alpine
    when:
      - evaluate: 'CI_COMMIT_MESSAGE not contains "chore(version):"'
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - apk add --no-cache git curl perl
      - curl -sSL https://github.com/cocogitto/cocogitto/releases/latest/download/cocogitto-6.5.0-x86_64-unknown-linux-musl.tar.gz | tar xz -C /tmp
      - mv /tmp/x86_64-unknown-linux-musl/cog /usr/local/bin/
      - git config --global user.name "Woodpecker CI"
      - git config --global user.email "ci@woodpecker.local"
      - git config --global --add safe.directory "$CI_WORKSPACE"
      - git fetch --unshallow --tags || git fetch --tags
      - git remote set-url origin "https://x-access-token:$GITHUB_TOKEN@github.com/barryw/sim6502.git"
      - |
        if cog bump --auto --dry-run 2>&1 | grep -qE "(No conventional commits|already on)"; then
          echo "No version bump needed"
          exit 0
        fi
      - cog bump --auto
      - git push origin HEAD:main --tags
      - |
        # Create GitHub release with changelog
        apk add --no-cache github-cli
        VERSION=$(git describe --tags --abbrev=0)
        PREV_VERSION=$(git describe --tags --abbrev=0 $VERSION^ 2>/dev/null || echo "")
        if [ -n "$PREV_VERSION" ]; then
          NOTES=$(git log --pretty=format:"- %s" $PREV_VERSION..$VERSION^)
        else
          NOTES=$(git log --pretty=format:"- %s" $VERSION^)
        fi
        gh release create "$VERSION" --title "$VERSION" --notes "$NOTES"
    depends_on: [build-and-test]

  - name: docker
    image: gcr.io/kaniko-project/executor:debug
    when:
      - evaluate: 'CI_COMMIT_MESSAGE not contains "chore(version):"'
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - |
        # Extract version from csproj file
        VERSION=$(sed -n 's/.*<Version>\([^<]*\)<\/Version>.*/\1/p' "$CI_WORKSPACE/sim6502/sim6502.csproj" | head -1)
        VERSION=${VERSION:-0.0.0}
        echo "Building Docker image: $VERSION"
        mkdir -p /kaniko/.docker
        echo "{\"auths\":{\"ghcr.io\":{\"username\":\"barryw\",\"password\":\"$GITHUB_TOKEN\"}}}" > /kaniko/.docker/config.json
        /kaniko/executor \
          --context="$CI_WORKSPACE" \
          --dockerfile="$CI_WORKSPACE/Dockerfile" \
          --destination="ghcr.io/barryw/sim6502:v$VERSION" \
          --destination="ghcr.io/barryw/sim6502:latest"
    depends_on: [release]
