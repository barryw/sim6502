when:
  - event: push
    branch: main
  - event: tag
    ref: refs/tags/v*

variables:
  - &dotnet_image "mcr.microsoft.com/dotnet/sdk:10.0-preview"

steps:
  # Build and test
  - name: build-and-test
    image: *dotnet_image
    commands:
      - dotnet restore
      - dotnet build -c Release --no-restore
      - dotnet test -c Release --no-build --no-restore

  # Version bump with cog (only on push to main, not tags)
  - name: version-bump
    image: alpine:latest
    when:
      - event: push
        branch: main
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
      GIT_AUTHOR_NAME: "Woodpecker CI"
      GIT_AUTHOR_EMAIL: "ci@barrywalker.io"
      GIT_COMMITTER_NAME: "Woodpecker CI"
      GIT_COMMITTER_EMAIL: "ci@barrywalker.io"
    commands:
      - apk add --no-cache git curl bash
      # Install cocogitto
      - curl -sSL https://github.com/cocogitto/cocogitto/releases/download/6.2.0/cocogitto-6.2.0-aarch64-unknown-linux-musl.tar.gz | tar xz -C /usr/local/bin
      # Configure git
      - git config --global user.email "ci@barrywalker.io"
      - git config --global user.name "Woodpecker CI"
      - git config --global --add safe.directory $CI_WORKSPACE
      # Set up git credentials for push
      - git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/barryw/sim6502.git
      # Bump version based on conventional commits
      - |
        if cog bump --auto; then
          echo "Version bumped successfully"
          git push origin main --tags
        else
          echo "No version bump needed or already at correct version"
        fi

  # Build and push Docker image on tags using kaniko
  - name: docker-build-push
    image: gcr.io/kaniko-project/executor:latest
    when:
      - event: tag
        ref: refs/tags/v*
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - |
        cat > /kaniko/.docker/config.json << EOF
        {
          "auths": {
            "ghcr.io": {
              "auth": "$(echo -n barryw:$GITHUB_TOKEN | base64)"
            }
          }
        }
        EOF
      - /kaniko/executor
        --context .
        --dockerfile Dockerfile
        --destination ghcr.io/barryw/sim6502:latest
        --destination ghcr.io/barryw/sim6502:${CI_COMMIT_TAG##v}
        --cache=true

  # Build and push latest on main push using kaniko
  - name: docker-build-push-latest
    image: gcr.io/kaniko-project/executor:latest
    when:
      - event: push
        branch: main
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - |
        cat > /kaniko/.docker/config.json << EOF
        {
          "auths": {
            "ghcr.io": {
              "auth": "$(echo -n barryw:$GITHUB_TOKEN | base64)"
            }
          }
        }
        EOF
      - /kaniko/executor
        --context .
        --dockerfile Dockerfile
        --destination ghcr.io/barryw/sim6502:latest
        --destination ghcr.io/barryw/sim6502:sha-${CI_COMMIT_SHA:0:8}
        --cache=true
