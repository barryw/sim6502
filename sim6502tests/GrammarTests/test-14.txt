suites {
  suite("Test Suite 14 - setup block") {
    symbols("TestPrograms/include_me_full.sym")
    load("TestPrograms/include_me_full.prg", strip_header = true)

    setup {
      ; Setup runs before each test
      $5000 = $42
      [r0L] = $11
      [r0H] = $22
      memfill($5100, 4, $aa)
    }

    test("setup-basic", "Setup runs before first test") {
      ; Verify setup initialized values correctly
      assert($5000 == $42, "Setup should have set $5000 to $42")
      assert([r0L] == $11, "Setup should have set r0L to $11")
      assert([r0H] == $22, "Setup should have set r0H to $22")
      assert($5100 == $aa, "Setup should have filled $5100 with $aa")
      assert($5101 == $aa, "Setup should have filled $5101 with $aa")

      ; Now modify these values to test that setup runs again
      $5000 = $ff
      [r0L] = $99
      [r0H] = $88
      $5100 = $33
    }

    test("setup-runs-again", "Setup runs before second test") {
      ; If setup runs again, all values should be reset to original setup values
      ; NOT the modified values from the previous test
      assert($5000 == $42, "Setup should have reset $5000 to $42, not $ff")
      assert([r0L] == $11, "Setup should have reset r0L to $11, not $99")
      assert([r0H] == $22, "Setup should have reset r0H to $22, not $88")
      assert($5100 == $aa, "Setup should have refilled $5100 with $aa, not $33")
    }

    test("setup-with-expressions", "Setup can use expressions") {
      ; Verify that the memfill from setup filled 4 bytes
      assert($5100 == $aa, "First byte should be $aa")
      assert($5101 == $aa, "Second byte should be $aa")
      assert($5102 == $aa, "Third byte should be $aa")
      assert($5103 == $aa, "Fourth byte should be $aa")
      assert($5104 != $aa, "Fifth byte should not be $aa (beyond fill range)")
    }

    test("setup-multiple-symbols", "Setup works with multiple symbol references") {
      ; Test that various symbol types work in setup
      assert([r0L] == $11, "r0L should be set by setup")
      assert([r0H] == $22, "r0H should be set by setup")

      ; Verify the actual memory locations
      assert($fb == $11, "r0L is at $fb, should be $11")
      assert($fc == $22, "r0H is at $fc, should be $22")
    }

    test("setup-does-not-affect-program-load", "Setup doesn't corrupt loaded program") {
      ; Verify that setup block doesn't interfere with program data
      ; The loaded program should still be intact
      ; (This assumes the program has some known values we can check)
      ; Just verify setup ran by checking our test locations
      assert($5000 == $42, "Setup memory at $5000 should be $42")
    }
  }

  suite("Test Suite 14b - setup with VIC symbols") {
    symbols("TestPrograms/include_me_full.sym")
    load("TestPrograms/include_me_full.prg", strip_header = true)

    setup {
      ; Use namespaced VIC symbols in setup
      ; Note: Cannot use vic.BGCOL0 as .B conflicts with Byte token in grammar
      [vic.EXTCOL] = $0e
      [vic.SCROLY] = $1b
      [vic.SP0X] = $80
      [vic.SP0Y] = $c8
    }

    test("setup-vic-symbols", "Setup works with VIC namespace symbols") {
      assert([vic.EXTCOL] == $0e, "EXTCOL should be $0e from setup")
      assert([vic.SCROLY] == $1b, "SCROLY should be $1b from setup")
      assert([vic.SP0X] == $80, "SP0X should be $80 from setup")
      assert([vic.SP0Y] == $c8, "SP0Y should be $c8 from setup")

      ; Modify values
      [vic.EXTCOL] = $ff
    }

    test("setup-vic-reset", "Setup resets VIC symbols between tests") {
      ; Should be reset to setup values, not $ff from previous test
      assert([vic.EXTCOL] == $0e, "EXTCOL should be reset to $0e by setup")
    }
  }

  suite("Test Suite 14c - multiple memfills in setup") {
    symbols("TestPrograms/include_me_full.sym")
    load("TestPrograms/include_me_full.prg", strip_header = true)

    setup {
      ; Multiple memfill operations
      memfill($6000, 16, $11)
      memfill($6100, 8, $22)
      memfill($6200, 4, $33)
      $6300 = $44
    }

    test("setup-multiple-memfills", "Setup can have multiple memfill operations") {
      assert($6000 == $11, "First fill: first byte")
      assert($600f == $11, "First fill: last byte")
      assert($6010 != $11, "First fill: beyond range")

      assert($6100 == $22, "Second fill: first byte")
      assert($6107 == $22, "Second fill: last byte")

      assert($6200 == $33, "Third fill: first byte")
      assert($6203 == $33, "Third fill: last byte")

      assert($6300 == $44, "Direct assignment")
    }
  }
}
